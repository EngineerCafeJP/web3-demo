## このリポジトリについて

はじめてスマートコントラクトを触る方向けの、最小構成の Foundry プロジェクトです。シンプルなカウンターコントラクトと、そのテスト／デプロイスクリプトを通じて以下を体験できます。

- Foundry のセットアップと概要理解
- Solidity コントラクトのビルドとテスト
- ローカルチェーン（Anvil）へのデプロイ
- `cast` コマンドによるコントラクト操作

## Foundry とは？

Foundry は Rust 製の Ethereum アプリケーション開発ツールキットです。高速・ポータブルで、下記のコンポーネントから構成されます。

- **Forge**: Solidity 向けのテスト／ビルドフレームワーク。
- **Cast**: コントラクト呼び出しやトランザクション送信を行う CLI ツール。
- **Anvil**: ローカルで完結する Ethereum 開発用ノード。
- **Chisel**: Solidity の対話型 REPL。

本リポジトリでは主に Forge / Cast / Anvil を使用します。

公式ドキュメント: <https://book.getfoundry.sh/>

## 前提条件

- Git が利用できること
- Rust 製の Foundry をインストールするために `curl` が利用できること
- Node.js 等は不要です
- Windowsの場合はWSL2が前提です

## セットアップ手順（Foundry 未インストールの場合）

0. すでにこのリポジトリをクローンし、`web3-demo-only-counter-contract/` ディレクトリにいることを前提とします。
1. Foundry をインストールします（`foundryup` は Foundry の公式インストーラです）。
   ```bash
   curl -L https://foundry.paradigm.xyz | bash
   ```
   - スクリプトは Foundry のバイナリを `~/.foundry/bin` に配置し、PATH 設定（`.bashrc` など）を追記します。指示に従い `source ~/.bashrc` を実行することで新しい PATH が読み込まれ、現在のシェルから `foundryup` を利用できるようになります。
2. Foundry をセットアップします。
   ```bash
   foundryup
   forge --version
   cast --version
   anvil --version
   ```
   - バージョンが表示されればセットアップ完了です。

すでに Foundry をインストール済みの場合は `foundryup` だけを実行して最新化してください。

## プロジェクト構成

- `src/Counter.sol`: シンプルなカウンターコントラクト
- `test/Counter.t.sol`: カウンターの挙動を確認するテスト
- `script/Counter.s.sol`: ローカルチェーンにデプロイするためのスクリプト

## 基本コマンド

### 1. 依存関係の取得（初回必須）

- Foundry プロジェクトでは依存ライブラリが `lib/` に配置されますが、このリポジトリでは `.gitignore` の対象になっているためクローン直後には存在しません。
- まずは標準ライブラリである `forge-std` を導入してください。
  ```bash
  forge install foundry-rs/forge-std
  ```
- Foundry v1 以降はデフォルトでコミットを生成しないため、`--no-commit` を付ける必要はありません（旧バージョンを使う場合のみ付与してください）。
- 追加のライブラリが必要になったら、`forge install <GitHubオーナー/リポジトリ>` 形式で同様にインストールできます。

### 2. コントラクトのビルド

```bash
forge build
```

- 成功すると `out/` ディレクトリにアーティファクトが生成されます（`.gitignore` によりバージョン管理対象外）。

### 3. テストの実行

```bash
forge test
```

- `-v` オプションでログを詳細化できます。(`forge --help` でこのオプションの詳細度説明もあり)
  - `forge test -v` : 各テストケースのトランザクションログを表示
  - `forge test -vv` : EVM opcode レベルのトレースを表示
  - `forge test -vvv` : さらに詳細なデバッグ情報を表示
- テストは `test/Counter.t.sol` にあり、`increment` と `setNumber` の挙動を確認します。
- `testFuzz_SetNumber` はファズテストで、Foundry がランダムな入力値を生成しながら複数回（既定は 256 回）実行します。
  - ログ出力は成功時に抑制されるため、結果を確認したい場合は `forge test -vvvvvv --match-test testFuzz_SetNumber` などでトレースを確認してください。

### 4. ローカルチェーン（Anvil）の起動

```bash
anvil
```

- デフォルトで 10 個のテストアカウントが生成され、秘密鍵とアドレスが標準出力に表示されます。
- 以降のコマンドは別ターミナルで実行します。

### 5. デプロイスクリプトの実行

別ターミナルでプロジェクト直下から以下を実行します。

```bash
forge script script/Counter.s.sol:CounterScript \
  --rpc-url http://127.0.0.1:8545 \
  --private-key <Anvilで表示された秘密鍵> \
  --broadcast
```

- `--broadcast` (P2P ネットワークにブロードキャストする)を付けると実際にトランザクションが送信されます（省略時はシミュレーションのみ）。
- デプロイ後にコントラクトアドレスがログに表示されます。再利用したい場合は控えておいてください。

### 6. cast でコントラクトと対話する

テスト用アカウントの 1 つを使い、デプロイしたカウンターを操作します。

1. 現在値を確認
   ```bash
   cast call <コントラクトアドレス> "number()(uint256)" --rpc-url http://127.0.0.1:8545
   ```
2. インクリメント（トランザクション送信）
   ```bash
   cast send <コントラクトアドレス> "increment()" \
     --rpc-url http://127.0.0.1:8545 \
     --private-key <Anvilで表示された秘密鍵>
   ```
3. 任意の値を設定
   ```bash
   cast send <コントラクトアドレス> "setNumber(uint256)" 42 \
     --rpc-url http://127.0.0.1:8545 \
     --private-key <Anvilで表示された秘密鍵>
   ```

上記を繰り返しながら、テストネットワークなしでスマートコントラクト開発の基本的な流れを学べます。

### 7. ガス代と ETH 残高を確認する

Anvil 上でもトランザクションを送信するとガス代が発生し、アカウントの ETH が減少します。以下のコマンドで実際に残高変化を確認してみましょう。

1. Anvil を起動したターミナルに表示されているアカウントの中から適当なものを選び、初期残高を確認します。
   ```bash
   cast balance <アドレス> --rpc-url http://127.0.0.1:8545
   ```
   - Anvil は各アカウントに 10,000 ETH を割り当てるため、初回は `10000 ETH` のような値が表示されます。
2. 上記のアドレスと対応する秘密鍵を使って、カウンターを操作するトランザクションを送信します。
   ```bash
   cast send <コントラクトアドレス> "increment()" \
     --rpc-url http://127.0.0.1:8545 \
     --private-key <秘密鍵>
   ```
3. 再度残高を確認します。
   ```bash
   cast balance <アドレス> --rpc-url http://127.0.0.1:8545
   ```
   - ガス代が引かれたため、残高が僅かに減少しているはずです（例: `9999.9999... ETH`）。

これはローカルチェーンでも EVM のガスルールがそのまま適用されているためです。本番と同様の動作を模擬できることが Foundry／Anvil を使う利点のひとつです。

## トラブルシューティング

- `foundryup` 実行後に `forge` コマンドが見つからない場合は、シェルの設定ファイル（`~/.bashrc` など）を再読み込みしてから再度確認してください。
- Anvil のポートが競合している場合は `anvil -p 8546` のように別ポートで起動し、`--rpc-url` も同じ値に変更してください。
- 既存のビルド結果に起因するエラーが出る場合は `forge clean` を実行してから再ビルドしてください。

## 次のステップ

- コントラクトの機能を追加してテストを拡張してみましょう。
- スクリプトに初期値の設定や追加操作を組み込み、デプロイ後の自動化を試してみましょう。
- 各コンポーネントのより詳細な解説は Foundry Book を参照してください。
