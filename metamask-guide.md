# MetaMask導入ガイド

このガイドは、web3やブロックチェーン、ウォレットを初めて触る方を想定した、[MetaMask](https://metamask.io/ja)（web3系のリンクを踏むときは、いつも以上にURLがちゃんとしてるか注意してください！！）の導入から基本的な使い方までのガイドです。
お気持ちとしては、「これを読みながらやれば一人でもなんとなく使える」くらいを目指しています。バージョン違いで UI が変わるだろうとかも含め、不備もあるかもですがご容赦くださいm(__)m

⚠️ **このドキュメントのスコープについて**
> このドキュメントでは、**ブラウザ拡張機能のMetaMask**を想定しています。
> MetaMaskにはブラウザ拡張機能以外にも、モバイルアプリなどがあります。

## 📋 目次

1. [MetaMaskとは](#metamaskとは)
2. [MetaMaskのインストール](#metamaskのインストール)
3. [アカウントの作成とリカバリーフレーズ](#アカウントの作成とリカバリーフレーズ)
4. [ネットワークの設定](#ネットワークの設定)
5. [アカウントとトークン](#アカウントとトークン)
6. [web3アプリとの接続](#web3アプリとの接続)
7. [トランザクションの承認](#トランザクションの承認)
8. [送金処理](#送金処理)
9. [トークンの受け渡し](#トークンの受け渡し)
10. [FAQ・トラブルシューティング](#faqトラブルシューティング)
11. [デモアプリ（web3-demo-only-mint）を使う際の手順](#デモアプリweb3-demo-only-mintを使う際の手順)

---

## MetaMaskについて

### ざっくりどんなもの？

MetaMaskは、ブロックチェーン上で操作を行うために必要な**秘密鍵を管理し、操作に署名（その操作を許可）したりするためのアプリ**です。

#### なぜMetaMaskが必要？

ブロックチェーン上で操作（送金、コントラクトの実行など）を行うには、その操作に**署名**する必要があります（送金する人が、ちゃんとアカウントの持ち主かを確かめたいので）。署名には**秘密鍵**が必要ですが、基本的に秘密鍵をWebアプリケーションに直接渡すことはありません（秘密鍵が盗まれたら、盗んだ人が自由にその秘密鍵で署名できて、そのアカウントの残高を自由に使われてしまう）。

そのため、以下のような仕組みが必要になります：
- 秘密鍵を安全に保管する場所
- Webアプリから操作の依頼を受けた時に、ユーザーの承認を得て署名を行う仕組み

MetaMaskは、この2つを提供します（実際の機能は色々ありますが）。秘密鍵をブラウザ内で安全に保管し（これが安全かは、もちろん他人が作ったアプリをどこまで信頼するか、というのもある）、Webアプリから操作の依頼があった時に、ユーザーに確認を取ってから署名を行います。

#### web3アプリを操作するときの具体的な流れ（どのへんでMetaMaskが出てくるか？）

1. **web3アプリでチェーンの状態変化を伴う操作（トランザクション発行を伴う操作）を行う**（例: トークンをミントする）
2. **アプリがMetaMaskに「この操作に署名してください」と依頼**（トークン移転の承認や、Gas 代用 ETH 移動の承認依頼）
3. **MetaMaskがユーザーに「この操作を承認しますか？」と確認**（トークン移転の承認や、Gas 代用 ETH 移動の承認確認）
4. **ユーザーが承認すると、MetaMaskが秘密鍵を使って署名**
5. **署名された操作がブロックチェーンに送信される**

この流れにより、秘密鍵をWebアプリに渡すことなく、ブロックチェーン上で操作を行うことができます。

### MetaMaskの主な機能

少し挙げると以下などがありますが、基本は「（アカウントに紐づく）秘密鍵の管理」です。
- **ウォレット機能**: 暗号資産（ETHやトークン）を保管・管理
- **アカウント管理**: 複数のアカウントを管理可能
- **ネットワーク接続**: ローカル、テストネット、メインネットなど様々なネットワークに接続
- **DApp連携**: web3アプリケーション（DApp）と接続してトランザクションを承認

### 重要な概念

- **アカウント**: ブロックチェーン上の識別子。アドレス（0xで始まる42文字の文字列）で識別される。このアドレスは、秘密鍵とペアになる公開鍵から作られる（例: `0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb`）
- **秘密鍵**: アカウントの公開鍵に紐づく秘密鍵。アカウントの操作をするために必要。他人に知られてはいけない情報。MetaMaskはこれを管理してくれる。
- **リカバリーフレーズ**: 12個または24個の単語の組み合わせ。これがあれば、そのフレーズから生成されたアカウントを復元できる
- **ネットワーク**: ブロックチェーンネットワークを構成する種々のネットワーク。同じアカウントでも、ネットワークが違えば別々の資産として管理される。
  - **ローカルネットワーク**: 自分のPC上で動く開発用のネットワーク（基本的に実際の価値がある資産は存在しない）
  - **テストネット**: 開発・テスト用の公開ネットワーク（基本的に実際の価値がある実際の資産は存在しない）
  - **メインネット**: 本番環境のネットワーク（実際の資産が使われる）
- **トランザクション**: ブロックチェーン上で行う、ブロックチェーンの状態を変更する操作（送金、コントラクト呼び出しなど）。すべてブロックチェーン上に記録される

---

## MetaMaskのインストール

### ステップ1: 公式サイトからインストール

1. **公式サイトにアクセス**
   - [MetaMask公式ダウンロードページ](https://metamask.io/ja/download) にアクセス（このページの「よくある質問」にもインストール手順あり）
   - ⚠️ **重要**: URLが正しいことを必ず確認してください。詐欺サイトに注意！！！

2. **ブラウザを選択**
   - Chrome、Firefox、Edge、Braveなどに対応
   - 使用しているブラウザを選択

3. **拡張機能をインストール**
   - 「Chromeに追加」などのボタンをクリック
   - ブラウザの拡張機能ストアに移動するので、そこで「追加」をクリック

4. **インストール確認**
   - ブラウザのツールバーにMetaMaskのアイコン（キツネのマーク）が表示されればOK

### ステップ2: 初回起動

1. **MetaMaskアイコンをクリック**
   - ブラウザのツールバーにあるMetaMaskアイコンをクリック

2. **利用規約の確認**
   - 利用規約とプライバシーポリシーを確認
   - （内容を読んで、同意できる内容であることを確認のうえ）「同意する」をクリック

3. **パスワードの設定**
   - MetaMaskをロック解除するためのパスワードを設定
   - このパスワードは**リカバリーフレーズとは別物**です
   - パスワードを忘れても、リカバリーフレーズがあれば復元できます（後述する復元できる範囲に注意）

---

## アカウントの作成とリカバリーフレーズ

### アカウントの作成

1. **「ウォレットを作成」を選択**
   - 初回起動時に「ウォレットを作成」と「ウォレットをインポート」の選択肢が表示されます
   - 新規作成の場合は「ウォレットを作成」を選択

2. **リカバリーフレーズの生成**
   - MetaMaskが自動的に12個（または24個）の単語を生成します
   - この単語の組み合わせが**リカバリーフレーズ**です

### リカバリーフレーズとは

リカバリーフレーズ（シードフレーズ、シークレットリカバリーフレーズとも呼ばれる）は、そのフレーズから生成されたアカウントを復元するための方法です。

#### 重要なポイント（特に、まじめに運用するアカウントの場合）

- **リカバリーフレーズがあれば、そのフレーズから生成されたアカウントを復元できます**
  - 別のブラウザやデバイスでMetaMaskを再インストールした場合
  - パスワードを忘れた場合
  - MetaMaskを削除してしまった場合
- **リカバリーフレーズが漏洩すると、そのフレーズから生成されたアカウントが乗っ取られる可能性があります**
  - 絶対に他人に見せない
  - むやみにスクリーンショットを取らない（クラウドに自動保存される可能性もある）
  - オンライン上に保存しない
- **リカバリーフレーズを紛失すると、アカウントを復元できません**
  - 紙に手書きで保存することを強く推奨
  - 安全な場所（金庫など）に保管

### リカバリーフレーズのバックアップ手順

1. **単語を順番通りにメモ**
   - 表示された12個（または24個）の単語を、**順番通りに**紙に手書きでメモ
   - 例: `abandon ability able about above absent absorb abstract absurd abuse access accident`

2. **確認画面で入力**
   - メモした単語を順番通りに入力して確認
   - これにより、正しくメモできたか確認できます

3. **安全な場所に保管**
   - 紙に書いたメモを安全な場所に保管
   - 複数箇所にコピーを保管するのも有効（ただし、漏洩リスクも上がる）

### リカバリーフレーズで復元できる範囲

⚠️ **重要な理解**: リカバリーフレーズで復元できるのは、**そのリカバリーフレーズから生成されたアカウントだけ**です。（参考：[How to restore your wallet from Secret Recovery Phrase](https://support.metamask.io/configure/wallet/how-to-restore-your-metamask-wallet-from-secret-recovery-phrase/)の「Existing Installation」のところ）

#### 復元できるアカウント

- ✅ **リカバリーフレーズから生成されたアカウント**: 復元できます
  - 例: リカバリーフレーズから「アカウント1」「アカウント2」「アカウント3」を作成した場合、リカバリーフレーズがあれば、これらのアカウントを復元できます

#### 復元できないアカウント

- ❌ **別のリカバリーフレーズから生成されたアカウント**: 復元できません
  - 例: 別のリカバリーフレーズで作成したアカウントは、元のリカバリーフレーズでは復元できません

- ❌ **秘密鍵を直接インポートしたアカウント**: リカバリーフレーズでは復元できません
  - 例: MetaMaskで「アカウントをインポート」→「秘密鍵をインポート」で追加したアカウントは、リカバリーフレーズでは復元できません
  - このようなアカウントを復元するには、**その秘密鍵自体**が必要です
  - つまり、秘密鍵をインポートしたアカウントを使っている場合、リカバリーフレーズだけでなく、**その秘密鍵も別途安全に保管する必要があります**

#### MetaMask管理のアカウントについて

MetaMaskで管理しているアカウントには、このガイドの範囲では、ざっくり以下の2種類があります：

1. **リカバリーフレーズから生成されたアカウント**
   - リカバリーフレーズがあれば復元可能
   - 通常、最初に「ウォレットを作成」で作成したアカウントや、「アカウントを作成」で追加したアカウント

2. **秘密鍵を直接インポートしたアカウント**
   - リカバリーフレーズでは復元できない
   - 秘密鍵を別途保管する必要がある
   - 「アカウントをインポート」→「秘密鍵をインポート」で追加したアカウント

### パスワードとリカバリーフレーズの違い

| 項目 | パスワード | リカバリーフレーズ |
|------|-----------|-------------------|
| 用途 | MetaMaskのロック解除 | アカウントの復元 |
| 紛失時の影響 | リカバリーフレーズで復元可能 | アカウントを復元できない |
| 変更可能 | 可能（設定から変更） | 不可能（変更すると別アカウントになる） |

---

## ネットワークの設定

MetaMaskは、様々なブロックチェーンネットワークに接続できます。ネットワークごとに設定が必要です。

### ネットワークの種類

1. **ローカルネットワーク（Anvilなど）**
   - ローカルPC上で動く開発用のネットワーク
   - テスト用のETHが無料で使える
   - 基本的に実際の価値がある資産は存在しない

2. **テストネット（Sepolia、Holeskyなど）**
   - 開発・テスト用の公開ネットワーク
   - テスト用のETHをFaucetから無料で取得できる
   - 基本的に実際の価値がある資産は存在しない

3. **メインネット（Ethereum Mainnet）**
   - 本番環境のネットワーク
   - 実際の価値があるETHやトークンが使われる
   - 送金には手数料（ガス代）がかかる

### ローカルネットワークの設定

ローカルネットワークは、ローカル（基本は自分のPCを想定）上で動く開発用のブロックチェーンネットワークです。このドキュメントでは、**Anvil**というツールを使う方法を説明しますが、Anvil以外のローカルネットワーク（Hardhat Networkなど）でも同様の手順で設定できます。

⚠️ **前提条件**  
- Anvil を使うには、**Foundry** というツールセットがインストールされている必要があります。
- Windows をお使いの場合、このガイドでは **WSL2（Windows Subsystem for Linux 2）上のターミナル** で作業する想定です。

まだ Foundry をインストールしていない場合は、次のコマンドを実行してインストールします：

```bash
curl -L https://foundry.paradigm.xyz | bash
foundryup
```

インストールが完了したら、`anvil --version` コマンドでインストールできているかを確認できます。

#### ステップ1: Anvilの起動

1. **ターミナル（コマンドライン）を開く**
   - Windows: WSL2 上のターミナル（Ubuntu など）
   - Mac / Linux: 通常のターミナル

2. **Anvilを起動**
   ```bash
   anvil
   ```

   ※ポートとかは `anvil` コマンドのオプションで指定できます。


3. **表示される情報を確認**
   Anvilが起動すると、以下のような情報が表示されます：
   ```
   Available Accounts
   ==================
   
   (0) 0x219Fd6e51aad88F6C4ce6aB8827279cffFb92262 (10000.000000000000000000 ETH)
   (1) 0x90197970C51813dc3A010C7d01b50e0d13dc79C0 (10000.000000000000000000 ETH)
   ...
   Private Keys
   ==================
   
   (0) 0xF10974bec39a17e36ba4a6b4d233ff944bacb478cbed5efcae784d7bf4f2df89
   (1) 0x30c6995e998f97a5a0244966f0945389dc9e86dae88c7a8412f4803b6b78a90a
   ...
   ```
   
   - ⚠️ **重要**: これらのアカウントアドレスと秘密鍵をメモしておきます（後でMetaMaskにインポートするため）
   - ⚠️ **注意**: Anvilを終了すると、このネットワークの状態はリセットされます（再起動すると新しい状態から始まります）

#### ステップ2: テストネットワークの表示を有効化（必要に応じて）

1. **MetaMaskを開く**
   - ブラウザのツールバーからMetaMaskアイコンをクリック

2. **設定を開く**
   - MetaMask右上の「設定」（歯車アイコン）をクリック
   - 「詳細設定」を選択

3. **「テストネットワークを表示」をONにする**
   - 「テストネットワークを表示」のスイッチをONにする
   - これにより、テストネットワークやローカルネットワークがネットワーク選択メニューに表示されやすくなります

※この手順じゃなくても、テストネットが選択できるように、表示を有効化できればOKです（設定箇所は複数あるので）。

#### ステップ3: MetaMaskにネットワークを追加

1. **MetaMaskを開く**
   - ブラウザのツールバーからMetaMaskアイコンをクリック

2. **ネットワーク選択メニューを開く**
   - 画面上部のネットワーク名（デフォルトでは「Ethereum Mainnet」など）をクリック
   - ネットワーク名の右側に下向きの矢印（▼）が表示されているはずです

3. **「ネットワークを追加」を選択**
   - 表示されたメニューの一番下にある「ネットワークを追加」をクリック
   - もし「ネットワークを追加」が見つからない場合は、メニューを下にスクロールしてください

4. **「ネットワークを手動で追加」を選択**
   - 表示された画面で「ネットワークを手動で追加」をクリック
   - または、直接ネットワーク情報を入力する画面が表示される場合もあります

5. **ネットワーク情報を入力**
   - 以下の情報を入力します：
     - **ネットワーク名**: `Anvil`（任意の名前でOK。例: "Local Anvil"、"開発環境"など）
     - **新しいRPC URL**: `http://127.0.0.1:8545`
       - ⚠️ **重要**: Anvilが起動している状態でないと、このURLに接続できません（ポートはAnvilが待ち受けているポート、デフォルトなら `8545`）
     - **チェーンID**: `31337`
       - ⚠️ **注意**: チェーンIDは数字のみを入力してください（デフォルトなら `31337`と入力、Anvil立ち上げ時に指定可能）
     - **通貨記号**: `ETH`
     - **ブロックエクスプローラーURL**: （空欄でOK）

6. **「保存」をクリック**
   - 入力が完了したら「保存」をクリック
   - ネットワークが追加され、自動的にAnvilネットワークに切り替わります

⚠️ **よくある問題**: ネットワーク選択メニューで、追加したローカルネットワークが表示されない、または選択できない場合があります。その場合は、以下の点を確認してください：

- ネットワーク名の部分（画面上部）をクリックして、メニューを開き直してください
- メニュー内でスクロールして、追加したネットワークを探してください
- ネットワーク名の右側に表示されるアイコン（地球儀のようなアイコン）をクリックして、ネットワークを切り替えることもできます

#### ステップ4: アカウントのインポート

Anvilで生成されたアカウントをMetaMaskにインポートします。

1. **アカウントメニューを開く**
   - MetaMask右上のアカウントアイコンをクリック
   - 「アカウントをインポート」を選択

2. **秘密鍵を入力**
   - 「秘密鍵をインポート」を選択
   - Anvilで表示された秘密鍵（`0x`から始まる文字列）を貼り付け
   - 「インポート」をクリック

3. **確認**
   - アカウントが追加され、ETH残高が表示されます（通常は 10000 ETH）

### テストネットの設定

テストネット（Sepolia、Holeskyなど）を使う場合の設定方法です。

#### ステップ1: テストネットを有効化

1. **設定を開く**
   - MetaMask右上の「設定」（歯車アイコン）をクリック
   - 「詳細設定」を選択

2. **テストネットワークを表示**
   - 「テストネットワークを表示」のスイッチをONにする
   - これにより、テストネットがネットワーク選択メニューに表示されます

#### ステップ2: テストネットを選択

1. **ネットワーク選択メニューを開く**
   - 画面上部のネットワーク名をクリック

2. **テストネットを選択**
   - 「Sepolia」や「Holesky」などのテストネットを選択
   - これでテストネットに接続されます

#### ステップ3: テストETHの取得（Faucet）

テストネットでは、実際のETHの代わりにテスト用のETHを使います。Faucet（蛇口）から無料で取得できます。

1. **Faucetサイトにアクセス**
   - Sepoliaの場合: [Google Cloud Faucet](https://cloud.google.com/application/web3/faucet/ethereum/sepolia)
   - Holeskyの場合: [Google Cloud Faucet](https://cloud.google.com/application/web3/faucet/ethereum/holesky)
   - その他のFaucetも検索で見つかります

   ※↑のSepoliaもですが、スパム対策で、メインネットで活動履歴のあるアカウントしか取得できない、とかがわりとあります。

2. **ネットワークを選択**
   - Faucetサイトで、使用するテストネットを選択

3. **ウォレットアドレスを入力**
   - MetaMaskで現在選択しているアカウントのアドレスをコピー
   - Faucetサイトの「Wallet address」欄に貼り付け

4. **リクエストを送信**
   - 「Request」や「Send」などのボタンをクリック
   - しばらく待つと、テストETHが送られてきます

5. **残高を確認**
   - MetaMaskで残高が増えていることを確認

### メインネットの設定

メインネットは、デフォルトでMetaMaskに追加されています。

1. **ネットワーク選択メニューを開く**
   - 画面上部のネットワーク名をクリック

2. **「Ethereum Mainnet」を選択**
   - メインネットに切り替わります

⚠️ **重要**: メインネットでは実際の資産が使われます。操作には十分注意してください。

### ネットワークの切り替え

開発中は、ローカル、テストネット、メインネットを頻繁に切り替えることがあります。

1. **ネットワーク選択メニューを開く**
   - 画面上部のネットワーク名をクリック

2. **使用するネットワークを選択**
   - 一覧から目的のネットワークを選択
   - 自動的に切り替わります

⚠️ **注意**: ネットワークを切り替えると、残高やトークンが変わります。これは正常な動作です。各ネットワークは独立しているため、ローカルのETHとテストネットのETHは別物です。

---

## アカウントとトークン

### アカウントの追加

既存のアカウント（秘密鍵やリカバリーフレーズから生成されたアカウント）を MetaMask に追加できます。

#### 方法1: 同じリカバリーフレーズからアカウントを増やす

すでに MetaMask に設定してあるリカバリーフレーズから、追加のアカウントを生成する場合：

1. **アカウントメニューを開く**
   - MetaMask 右上のアカウントアイコンをクリック
   - 「アカウントを作成」を選択

2. **アカウントが追加される**
   - 同じリカバリーフレーズから生成された「次のアカウント」が自動的に追加されます
   - 1 つのリカバリーフレーズからは、理論上無制限にアカウントを生成できます

#### 方法2: 秘密鍵からインポート

別のリカバリーフレーズから生成されたアカウントや、秘密鍵を直接持っているアカウントを追加する場合：

1. **アカウントメニューを開く**
   - MetaMask右上のアカウントアイコンをクリック
   - 「アカウントをインポート」を選択

2. **「秘密鍵をインポート」を選択**
   - 「秘密鍵をインポート」タブを選択

3. **秘密鍵を入力**
   - 秘密鍵（`0x`から始まる64文字の文字列）を貼り付け
   - 「インポート」をクリック

4. **確認**
   - アカウントが追加されます

⚠️ **注意**: 秘密鍵をインポートしたアカウントは、リカバリーフレーズでは復元できません。秘密鍵を別途安全に保管する必要があります。

### トークンのインポート

ERC20トークン（イベントで使うDEMOトークンなど）をMetaMaskに表示させる方法です。

#### 方法1: トークンアドレスから自動検出

1. **「トークンをインポート」をクリック**
   - MetaMaskのホーム画面下部にある「トークンをインポート」をクリック

2. **「カスタムトークン」タブを選択**
   - 「カスタムトークン」タブをクリック

3. **トークンコントラクトアドレスを入力**
   - トークンのコントラクトアドレス（`0x`で始まる文字列）を入力
   - 例: `0x5FbDB2315678afecb367f032d93F642f64180aa3`

4. **自動入力される情報を確認**
   - トークンシンボル（例: `DEMO`）と小数点（例: `18`）が自動入力されます
   - 正しく表示されない場合は、手動で入力

5. **「トークンを追加」をクリック**
   - トークンが追加され、残高が表示されます

#### 方法2: 手動で情報を入力

自動検出されない場合（ローカルネットワークなど）は、手動で情報を入力します。

1. **「トークンをインポート」をクリック**
   - MetaMaskのホーム画面下部にある「トークンをインポート」をクリック

2. **「カスタムトークン」タブを選択**

3. **情報を入力**
   - **トークンコントラクトアドレス**: コントラクトのアドレス
   - **トークンシンボル**: トークンの略称（例: `DEMO`）
   - **トークンの小数点**: 通常は`18`（ERC20の標準）

4. **「トークンを追加」をクリック**

#### トークンが表示されない場合

- **ネットワークを確認**: 正しいネットワークに接続しているか確認
- **コントラクトアドレスを確認**: アドレスが正しいか確認
- **残高を確認**: そのネットワークのそのアカウントに、トークンが実際にあるか確認（Etherscanなどのブロックチェーンエクスプローラーで確認可能）

---

## web3アプリとの接続

web3アプリケーション（DApp）とMetaMaskを接続（コントラクトの関数を呼び出す準備）する方法です。

### 接続の流れ

1. **アプリが接続を要求**
   - web3アプリの「ウォレットを接続」などのボタンをクリック（アプリUIによる）

2. **MetaMaskがポップアップを表示**
   - ブラウザにMetaMaskの接続確認画面が表示されます

3. **接続を承認**
   - 接続するアカウントを選択
   - 「次へ」→「接続」をクリック

4. **接続完了**
   - アプリがアカウント情報を取得し、接続が完了します

### 接続時の注意点

- **接続しても資産は移動しません**: 接続するだけでは、アカウント情報をアプリに提供するだけです
- **接続を解除できます**: 後で接続を解除することも可能です
- **複数のアカウントから選択可能**: 複数のアカウントがある場合、接続時に選択できます

### 接続の解除方法

1. **MetaMaskを開く**
   - ブラウザのツールバーからMetaMaskアイコンをクリック

2. **「アクセス許可の管理」を開く**
   - 右上の「︙」（三点メニュー）をクリック
   - 「アクセス許可の管理」（っぽい名前の項目）を選択

3. **接続を解除**
   - 接続しているアプリの一覧が表示されます
   - 解除したいアプリの「削除」をクリック

---

## トランザクションの承認

web3アプリで操作（送金、コントラクト関数の呼び出しなど）を行うと、MetaMaskがトランザクション承認画面を表示します。

### なぜMetaMaskが呼ばれるのか

ブロックチェーンへ書き込みなどの操作を行うには、**トランザクションに署名する**必要があります。署名には秘密鍵が必要ですが、秘密鍵をweb3アプリに直接渡すことはできません（セキュリティ上の理由）。

そのため、以下の流れになります：

1. **web3アプリが操作を要求**
   - 例: 「100 DEMOトークンをミントする」

2. **トランザクションが作成される**
   - web3アプリが、ブロックチェーンに送信するトランザクションを作成

3. **MetaMaskが署名を要求**
   - トランザクションに署名するため、秘密鍵を管理するアプリのMetaMaskが呼び出される
   - ユーザーがMetaMaskで承認すると、秘密鍵を使って署名が行われる

4. **トランザクションが送信される**
   - 署名されたトランザクションがブロックチェーンに送信される

### トランザクション承認画面の見方

MetaMaskのトランザクション承認画面には、以下の情報が表示されます：

#### 基本情報

- **送信元**: トランザクションを送信するアカウント（操作を行うアカウント）
- **送信先**: トランザクションの送信先（コントラクトアドレスなど）
- **金額**: 送信するETHの量（トークンの場合は別途表示）

#### ガス（手数料）情報

- **ガス制限**: トランザクションで使用できる最大のガス量
- **ガス価格**: 1ガスあたりの価格
- **最大手数料**: トランザクションの最大手数料（ガス制限 × ガス価格）

⚠️ **注意**: ガス代は実際のETH（またはテストネットのETH）から支払われます。メインネットでは実際のお金がかかります（メインネットのETHは現実資産の価値と紐づいているという意味で）。

#### 詳細情報

「詳細を表示」をクリックすると、より詳細な情報が表示されます：

- **データ**: トランザクションに含まれるデータ（コントラクト関数の呼び出し情報など）
- **16進数データ**: データの16進数表現

### 承認の操作手順

1. **トランザクション内容を確認**
   - 送信先、金額、手数料などを確認
   - 不審な点がないか確認

2. **「確認」をクリック**
   - 内容に問題がなければ「確認」をクリック
   - パスワードの入力が求められる場合があります

3. **処理の待機**
   - トランザクションがブロックチェーンに送信されます
   - 処理が完了するまで待ちます（通常は数秒〜数分）

4. **完了確認**
   - トランザクションが完了すると、MetaMaskに通知が表示されます
   - web3アプリの画面も更新されます

### トランザクションを拒否する場合

- **「拒否」をクリック**: トランザクションをキャンセルできます
- **ポップアップを閉じる**: ポップアップを閉じてもトランザクションは送信されません

### よくある操作例

#### 例1: （ETHではない）トークンのミント

1. web3アプリで「トークンをミント」ボタンをクリック
2. MetaMaskが表示され、以下のような情報が表示されます：
   - **送信先**: トークンコントラクトのアドレス
   - **金額**: 0 ETH + ガス代（実装にもよるけど、トークンのミントにはETHは送信されない、ただしガス代は必要）
   - **データ**: `mint`関数の呼び出し情報
3. 「確認」をクリック
4. トランザクションが完了すると、トークン残高が増えます

#### 例2: （ETHではない）トークンの送金

1. web3アプリで「送金」ボタンをクリック
2. 送信先アドレスと数量を入力
3. MetaMaskが表示され、以下のような情報が表示されます：
   - **送信先**: トークンコントラクトのアドレス（トークンの送金はコントラクト経由）
   - **金額**: 0 ETH + ガス代（実装にもよるけど、トークンの送金にはETHは送信されない、ただしガス代は必要）
   - **データ**: `transfer`関数の呼び出し情報
4. 「確認」をクリック
5. トランザクションが完了すると、送信先のトークン残高が増えます

---

## 送金処理

ETHや、（ETHではない）トークンを他のアカウントに送金する方法です。

### ETHの送金

#### ステップ1: 送金画面を開く

1. **MetaMaskを開く**
   - ブラウザのツールバーからMetaMaskアイコンをクリック

2. **「送信」をクリック**
   - ホーム画面の「送信」ボタンをクリック

#### ステップ2: 送金先と金額を入力

1. **送金先アドレスを入力**
   - 「受取人」欄に、送金先のアカウントアドレス（`0x`で始まる文字列）を入力
   - または、QRコードをスキャン

2. **送金金額を入力**
   - 「金額」欄に、送金するETHの量を入力
   - 例: `0.1`（0.1 ETH）

3. **「次へ」をクリック**

#### ステップ3: 確認と承認

1. **送金内容を確認**
   - 送金先、金額、手数料を確認

2. **「確認」をクリック**
   - 内容に問題がなければ「確認」をクリック

3. **処理の待機**
   - トランザクションがブロックチェーンに送信されます
   - 処理が完了するまで待ちます

### （ETHではない）トークンの送金

#### ステップ1: トークンを選択

1. **MetaMaskを開く**
   - ホーム画面で、送金したいトークンを確認

2. **トークンをクリック**
   - 送金したいトークン（例: DEMO）をクリック

3. **「送信」をクリック**
   - トークン詳細画面の「送信」ボタンをクリック

#### ステップ2: 送金先と金額を入力

1. **送金先アドレスを入力**
   - 「受取人」欄に、送金先のアカウントアドレスを入力

2. **送金金額を入力**
   - 「金額」欄に、送金するトークンの量を入力
   - 例: `100`（100 DEMO）

3. **「次へ」をクリック**

#### ステップ3: 確認と承認

1. **送金内容を確認**
   - 送金先、金額、手数料を確認
   - ⚠️ **注意**: トークンの送金にもガス代（ETH）が必要です

2. **「確認」をクリック**
   - 内容に問題がなければ「確認」をクリック

3. **処理の待機**
   - トランザクションがブロックチェーンに送信されます

### 送金時の注意点

- **アドレスの確認**: 送金先アドレスが正しいか必ず確認してください。間違ったアドレスに送金すると、取り戻せません
- **ガス代**: 送金にはガス代（手数料）がかかります。ガス代はETHで支払われます
- **ネットワークの確認**: 正しいネットワークに接続しているか確認してください。異なるネットワーク間では送金できません
- **残高の確認**: 送金する金額とガス代を合わせて、残高が足りるか確認してください

---

## トークンの受け渡し

トークンを受け取る方法と、受け取ったトークンを確認する方法です。

### トークンを受け取る

トークンを受け取るために特別な操作は必要ありません（表示するための設定だけ必要）。他のアカウントからトークンが送られてくると、自動的にそのアカウントに追加されます。

#### 受け取りの確認方法

1. **MetaMaskを開く**
   - ホーム画面でトークン一覧を確認

2. **トークンが表示されているか確認**
   - トークンが既にインポートされている場合、残高が更新されます
   - トークンがインポートされていない場合、表示されないことがあります

3. **トークンをインポート（必要に応じて）**
   - トークンが表示されない場合は、[トークンのインポート](#トークンのインポート)の手順に従ってインポート

### トークンアドレスの共有

他の人にトークンを送ってもらう場合、自分のアカウントアドレスを共有する必要があります。

#### アドレスのコピー方法

1. **MetaMaskを開く**
   - ホーム画面で、アカウント名の下にあるアドレスをクリック
   - または、アカウント名をクリックして詳細画面を開き、アドレスをコピー

2. **アドレスを共有**
   - コピーしたアドレスを、トークンを送ってくれる人に共有

### トークンの残高確認

1. **MetaMaskのホーム画面で確認**
   - トークン一覧に残高が表示されます

2. **ブロックチェーンエクスプローラーで確認**
   - テストネットの場合: [Etherscan](https://etherscan.io/)のテストネット版（[Sepolia版](https://sepolia.etherscan.io/)など、ネットワークごとにあるので注意）
   - ローカルネットワークの場合: エクスプローラーが利用可能な場合
   - ブロックチェーンエクスプローラーでアカウントアドレスを検索すると、所有しているトークンと残高が表示されます

---

## FAQ・トラブルシューティング

### インストール・セットアップ関連

#### Q: MetaMaskがインストールできない

**A:** 以下の点を確認してください：

1. **ブラウザの互換性**: Chrome、Firefox、Edge、Braveなどの対応ブラウザを使用しているか確認
2. **公式サイトからインストール**: 必ず[公式サイト](https://metamask.io/ja/download)からインストールしてください（詐欺サイトに注意！！！）
3. **拡張機能の権限**: ブラウザの拡張機能のインストールが許可されているか確認

#### Q: パスワードを忘れた

**A:** リカバリーフレーズがあれば復元できます：

1. MetaMaskを削除して再インストール
2. 「ウォレットをインポート」を選択
3. リカバリーフレーズを入力して復元

⚠️ **注意**: リカバリーフレーズがない場合は復元できません。

#### Q: リカバリーフレーズを紛失した

**A:** 残念ながら、リカバリーフレーズを紛失するとアカウントを復元できません。以下の対策を検討してください：

1. **まだアクセスできる場合**: すぐに資産を別のアカウントに移す
2. **既にアクセスできない場合**: アカウントは復元できません

⚠️ **重要**: リカバリーフレーズは必ず安全な場所に保管してください。

### ネットワーク関連

#### Q: ネットワークが追加できない

**A:** 以下の点を確認してください：

1. **RPC URLの確認**: URLが正しいか確認（例: `http://127.0.0.1:8545`）
2. **チェーンIDの確認**: チェーンIDが正しいか確認（Anvilの場合はデフォルトが`31337`）
3. **Anvilが起動しているか**: ローカルネットワークの場合、Anvilなどローカルのブロックチェーンが起動しているか確認

#### Q: ネットワークを切り替えても残高が変わらない/残高が変わる

**A:** 各ネットワークは独立しているため、ネットワークごとに残高が異なります。ネットワークごとのアカウント残高が正しければ、正常動作です。

- **ローカルネットワーク**: Anvilで生成されたETH
- **テストネット**: Faucetから取得したテストETH
- **メインネット**: 実際のETH

これらは別物なので、残高が異なるのは正常です。

#### Q: テストネットのETHが取得できない

**A:** 以下の点を確認してください：

1. **ネットワークの確認**: 正しいテストネットに接続しているか確認
2. **Faucetの制限**: 多くのFaucetには時間制限や数量制限があります。しばらく待ってから再度試してください
3. **別のFaucetを試す**: 複数のFaucetサイトがあるので、別のものを試してください

### アカウント・トークン関連

#### Q: アカウントをインポートできない

**A:** 以下の点を確認してください：

1. **秘密鍵の形式**: 秘密鍵は`0x`から始まる64文字の文字列です。正しい形式か確認してください
2. **コピー&ペーストの確認**: 秘密鍵が正しくコピーされているか確認（余分なスペースなどがないか、すべての桁が間違っていないか）
3. **ネットワークの確認**: そのアカウントが存在するネットワークに接続しているか確認

#### Q: トークンが表示されない

**A:** 以下の手順を試してください：

1. **トークンをインポート**: [トークンのインポート](#トークンのインポート)の手順に従ってインポート
2. **ネットワークの確認**: 正しいネットワークに接続しているか確認
3. **コントラクトアドレスの確認**: トークンのコントラクトアドレスが正しいか確認
4. **残高の確認**: ブロックチェーンエクスプローラーで、実際にトークンがあるか確認

#### Q: トークンが「ETH」と表示される（ローカル環境）

**A:** これはMetaMaskのキャッシュの問題の可能性があります。以下の手順を試してみてください：

1. **トークンを非表示にする**
   - トークン一覧で、誤表示されているトークンをクリック
   - 右上の「︙」→「トークンを非表示」を選択

2. **トークンを再インポート**
   - 「トークンをインポート」→「カスタムトークン」
   - コントラクトアドレスを入力
   - トークンシンボルと小数点が正しく表示されるか確認
   - 「トークンを追加」をクリック

3. **まだ直らない場合**
   - MetaMaskの設定 → 詳細設定 → 「アカウントをリセット」を試す
   - または、Anvilをリセットして再デプロイ

4. **それでも直らない場合**
   - MetaMaskをアンインストールして再インストール

### 接続・トランザクション関連

#### Q: web3アプリに接続できない

**A:** 以下の点を確認してください：

1. **MetaMaskがインストールされているか**: ブラウザにMetaMaskがインストールされているか確認
2. **HTTPサーバー経由で開いているか**: `file://`プロトコルでは動作しません。必ずHTTPサーバー経由で開いてください
3. **ポップアップブロック**: ブラウザのポップアップブロックが有効になっていないか確認
4. **ネットワークの確認**: アプリが要求するネットワークに接続しているか確認

#### Q: トランザクションが承認されない

**A:** 以下の点を確認してください：

1. **残高の確認**: 送金する金額とガス代を合わせて、残高が足りるか確認
2. **ネットワークの確認**: 正しいネットワークに接続しているか確認
3. **ガス価格の確認**: ガス価格が低すぎる場合、処理が遅くなることがあります
4. **トランザクションのキャンセル**: 以前のトランザクションが保留中のままの場合、新しいトランザクションが処理されないことがあります

#### Q: トランザクションが完了しない

**A:** 以下の点を確認してください：

1. **ネットワークの状態**: ネットワークが混雑している場合、処理に時間がかかることがあります
2. **ガス価格**: ガス価格が低すぎる場合、マイナーに選ばれにくくなり完了に時間がかかる可能性が高いです
3. **トランザクションの確認**: ブロックチェーンエクスプローラーでトランザクションの状態を確認

#### Q: 「ガス不足」エラーが出る

**A:** 以下の点を確認してください：

1. **残高の確認**: ETHの残高がガス代を支払うのに十分か確認
2. **ガス制限の確認**: トランザクションに必要なガス量が、ガス制限を超えていないか確認
3. **ネットワークの確認**: 正しいネットワークに接続しているか確認

#### Q: 「User rejected the request」エラーが出る

**A:** これは、ユーザーがトランザクションや接続要求を拒否したことを意味します。正常な動作です。

- **接続要求を拒否した場合**: 再度「ウォレットを接続」ボタンをクリックして、今度は承認してください
- **トランザクションを拒否した場合**: 再度操作を試してください

#### Q: 「insufficient funds for gas」エラーが出る

**A:** ガス代を支払うためのETHが不足しています。

1. **残高を確認**: ETHの残高を確認してください
2. **テストネットの場合**: FaucetなどからテストネットのETHを取得してください
3. **ローカルネットワークの場合**: Anvilからインポートしたアカウントには通常10000 ETHが入っているはずです。別のアカウントを使っている場合は、Anvilのアカウントに切り替えてください

#### Q: 「nonce too high」エラーが出る

**A:** トランザクションの順序が正しくない場合に発生します。

1. **保留中のトランザクションを確認**: MetaMaskで保留中のトランザクションがないか確認
2. **アカウントをリセット**: MetaMaskの設定 → 詳細設定 → 「アカウントをリセット」を試す（⚠️ 注意: これにより保留中のトランザクションがすべてキャンセルされます）
3. **ネットワークを切り替えて戻す**: 一度別のネットワークに切り替えて、元のネットワークに戻す

#### Q: 「execution reverted」エラーが出る

**A:** コントラクトの実行が失敗しました。これは、コントラクト側の問題である可能性が高いです。

1. **コントラクトアドレスの確認**: 正しいコントラクトアドレスを使っているか確認
2. **ネットワークの確認**: コントラクトがデプロイされているネットワークに接続しているか確認
3. **パラメータの確認**: 関数に渡しているパラメータが正しいか確認（例: 数量が適切か、アドレスが正しいか）

#### Q: 「network error」や「Failed to fetch」エラーが出る

**A:** ネットワーク接続の問題です。

1. **RPC URLの確認**: ネットワーク設定のRPC URLが正しいか確認
2. **Anvilが起動しているか**: ローカルネットワークの場合、Anvilが起動しているか確認
3. **インターネット接続**: テストネットやメインネットの場合、インターネット接続を確認
4. **RPCプロバイダーの問題**: RPCプロバイダーがダウンしている可能性があります。別のRPC URLを試してください

### その他

#### Q: 複数のアカウントを管理したい

**A:** 以下の方法で複数のアカウントを管理できます：

1. **同じリカバリーフレーズから生成**: アカウントメニュー → 「アカウントを作成」で追加
2. **別のリカバリーフレーズからインポート**: アカウントメニュー → 「アカウントをインポート」で秘密鍵をインポート

#### Q: アカウント名を変更したい

**A:** 以下の手順で変更できます：

1. **アカウント詳細を開く**: アカウント名をクリック
2. **「編集」をクリック**: アカウント名の横にある「編集」アイコンをクリック
3. **名前を変更**: 新しい名前を入力して保存

#### Q: 接続しているアプリの一覧を確認したい

**A:** 以下の手順で確認できます：

1. **MetaMaskを開く**: 右上の「︙」をクリック
2. **「アクセス許可の管理」を選択**: 接続しているアプリの一覧が表示されます

#### Q: セキュリティのために何をすべきか

**A:** 以下の点に注意してください：

1. **リカバリーフレーズの管理**: 絶対に他人に見せない、オンライン上に保存しない
2. **公式サイトからインストール**: 必ず公式サイトからインストール
3. **不審なサイトに接続しない**: 信頼できるサイトのみに接続
4. **トランザクション内容の確認**: トランザクション承認時は、必ず内容を確認
5. **パスワードの管理**: MetaMaskのパスワードも安全に管理

---

## デモアプリ（web3-demo-only-mint）を使う際の手順

このセクションでは、デモアプリ[`web3-demo-only-mint`](https://github.com/EngineerCafeJP/web3-demo/tree/main/web3-demo-only-mint)を使う際の、MetaMaskの設定から操作までの具体的な手順を説明します。

### 前提条件

このデモアプリを使う前に、以下の準備が必要です：

1. **Foundryのインストール**
   - Anvilを使うには、Foundryがインストールされている必要があります
   - まだインストールしていない場合は、以下のコマンドでインストール：
     ```bash
     curl -L https://foundry.paradigm.xyz | bash
     foundryup
     ```
   - インストール確認: `anvil --version` コマンドでインストールされていることを確認できます

2. **MetaMaskのインストール**
   - ブラウザにMetaMaskがインストールされていること
   - まだインストールしていない場合は、[MetaMaskのインストール](#metamaskのインストール)のセクションを参照

3. **デモアプリの準備**
   - デモアプリのコントラクトがデプロイされていること（後述のステップ2で説明）

### ステップ1: Anvilの起動とネットワーク設定

1. **Anvilを起動**
   - ターミナル（コマンドライン）を開く
   - 以下のコマンドを実行：
     ```bash
     anvil
     ```
   - ⚠️ **重要**: Anvilを起動したままにしておいてください（別のターミナルウィンドウで作業を続けます）

2. **表示される情報をメモ**
   - Anvilが起動すると、アカウントアドレスと秘密鍵が表示されます
   - ⚠️ **重要**: これらの情報をメモしておきます（後でMetaMaskにインポートするため）
   - 例：
     ```
     (0) 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 (10000 ETH)
     Private Key: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
     ```

3. **MetaMaskにAnvilネットワークを追加**
   - [ローカルネットワークの設定](#ローカルネットワークの設定)のセクションの手順に従って、Anvilネットワークを追加してください（ポート番号はローカルネットワーク、この場合はAnvilのポート番号）
   - 特に、[ステップ2: テストネットワークの表示を有効化](#ステップ2-テストネットワークの表示を有効化必要に応じて)も実行しておくと、後でネットワークを選択しやすくなります

4. **アカウントをインポート**
   - Anvilで表示された秘密鍵を使って、MetaMaskにアカウントをインポートしてください
   - 手順は[アカウントのインポート](#方法2-秘密鍵からインポート)のセクションを参照

### ステップ2: コントラクトのデプロイ

1. **コントラクトをデプロイ**
   - デモアプリのREADMEに従ってコントラクトをデプロイ
   - デプロイされたコントラクトアドレスをメモ

2. **デフォルトアドレスの確認**
   - Anvilの標準デプロイ先は `0x5FbDB2315678afecb367f032d93F642f64180aa3`
   - このアドレスがデフォルトでアプリに入力されています

### ステップ3: フロントエンドの起動

1. **HTTPサーバーを起動**
   ```bash
   # プロジェクトのルートディレクトリで実行
   python3 -m http.server 8000
   ```
   または
   ```bash
   http-server -p 8000
   ```

2. **ブラウザで開く**
   - `http://localhost:8000` を開く（ポート番号はフロントエンドのポート番号）
   - ⚠️ **重要**: `file://`プロトコルでは動作しません

### ステップ4: MetaMaskでアプリに接続

1. **アプリの画面を確認**
   - 「トークンコントラクトアドレス」欄にコントラクトアドレスが入力されていることを確認
   - デフォルトでは `0x5FbDB2315678afecb367f032d93F642f64180aa3` が入力されています

2. **「ウォレットを接続」をクリック**
   - アプリの「ウォレットを接続」ボタンをクリック

3. **MetaMaskで接続を承認**
   - MetaMaskのポップアップが表示されます
   - 接続するアカウントを選択（Anvilからインポートしたアカウント）
   - 「次へ」→「接続」をクリック

4. **接続確認**
   - アプリ画面に、ウォレットアドレス、残高、コントラクトアドレスが表示されればOK

### ステップ5: トークンのミント

1. **ミント数量を入力**
   - 「ミント数量（DEMO）」欄に、ミントしたい数量を入力
   - デフォルトは `100`

2. **「トークンをミント」をクリック**
   - 「トークンをミント」ボタンをクリック

3. **MetaMaskでトランザクションを承認**
   - MetaMaskのトランザクション承認画面が表示されます
   - 内容を確認（送信先はコントラクトアドレス、金額は0 ETH）
   - 「確認」をクリック

4. **処理の待機**
   - トランザクションが処理されるまで待ちます（通常は数秒）
   - ローカルネットワークなので、処理は高速です

5. **残高の確認**
   - ミントが完了すると、残高が更新されます
   - 残高が更新されない場合は、「残高を更新」ボタンをクリック

### よくある問題と対処法

#### 問題1: 「MetaMaskをインストールしてください」と表示される

**原因**: 
- MetaMaskがインストールされていない
- または、`file://`プロトコルで開いているなど

**対処法**:
1. MetaMaskがインストールされているか確認
2. HTTPサーバー経由で開いているか確認（`http://localhost:8000`）

#### 問題2: 接続できない、または「ネットワークエラー」と表示される

**原因**:
- MetaMaskがAnvilネットワークに接続されていない
- Anvilが起動していない

**対処法**:
1. MetaMaskでAnvilネットワークが選択されているか確認
2. Anvilが起動しているか確認（ターミナルで確認）
3. ネットワーク設定が正しいか確認（RPC URL: `http://127.0.0.1:8545`、チェーンID: `31337`、Anvil立ち上げ時にポート番号やチェーンIDを指定している場合は指定したポート番号やチェーンID）

#### 問題3: トークンが表示されない、または「ETH」と表示される

**原因**:
- トークンがインポートされていない
- MetaMaskのキャッシュの問題

**対処法**:
1. トークンをインポート（[トークンのインポート](#トークンのインポート)を参照）
2. トークンが「ETH」と表示される場合は、[FAQの該当項目](#q-トークンがethと表示されるローカル環境)を参照

#### 問題4: トランザクションが承認されない

**原因**:
- ETHの残高が不足している（ガス代が払えない）
- ネットワークが正しく設定されていない

**対処法**:
1. Anvilからインポートしたアカウントには、通常10000 ETHが入っているはずです。残高を確認
2. ネットワークがAnvilになっているか確認

#### 問題5: 残高が更新されない

**原因**:
- アプリが自動更新していない（正常な動作）
- 別のタブやデバイスで操作した場合

**対処法**:
- 「残高を更新」ボタンをクリックして手動で更新

---

## まとめ

このガイドでは、MetaMaskの基本的な使い方を解説しました。以下のポイントを押さえておけば、web3アプリを使い始められます：

1. **秘密鍵とリカバリーフレーズの安全な保管**: 最重要事項
2. **ネットワークの理解**: ローカル、テストネット、メインネットの違い
3. **トランザクション承認の流れ**: なぜMetaMaskが呼ばれるのか、何を承認しているのか
4. **セキュリティ意識**: 不審なサイトに接続しない、トランザクション内容を確認する

デモアプリ（`web3-demo-only-mint`）を使う際は、このガイドを参考に、MetaMaskを設定してアプリと接続してください。

不明な点や問題が発生した場合は、FAQ・トラブルシューティングのセクションを参照するか、公式ドキュメントを確認してください。

---

## 参考リンク

- [MetaMask公式サイト](https://metamask.io/)
- [MetaMask公式ドキュメント](https://docs.metamask.io/)
- [Etherscan（ブロックチェーンエクスプローラー）](https://etherscan.io/)
- [ChainList（ネットワーク情報）](https://chainlist.org/)

